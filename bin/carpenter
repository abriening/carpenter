#!/usr/bin/env ruby
require 'rubygems'
require "carpenter"
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: carpenter COMMAND [options]"
  opts.on("-o", "--output=[TYPE]", [:tree, :xml], "Output type for show command (tree, xml)"){|o|options[:output] = o }
end.parse!

command = ARGV.shift || 'build'

definitions = Carpenter::DefinitionCollection.new
definitions.load_requirements File.join(Dir.pwd, "requirements.json")
definitions.load_definitions File.join(Dir.pwd, "requirements/**/*.rb")

case command
when 'show'
  tree = Carpenter::Tree.new(definitions.requirements, definitions.verifications, definitions.plans)
  case options[:output]
  when :xml
    puts tree.to_xml
  else
    puts tree.to_tree
  end
when 'build'
  build = Carpenter::Build.new(definitions.requirements, definitions.verifications, definitions.plans)
  build.run
end

