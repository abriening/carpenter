#!/usr/bin/env ruby
require 'rubygems'
require "carpenter"
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: carpenter COMMAND [options]"
  opts.on("-o", "--output=TYPE", [:tree, :xml], "Output type for show & verify commands (tree, xml)"){|o| options[:output] = o }
  opts.on("-r", "--requirements=FILE", "Use an alternate location of requirements.json"){|o| options[:requirements] = o }
end.parse!

command = ARGV.shift || 'build'
requirements = options[:requirements] || File.join(Dir.pwd, "requirements.json")

definitions = Carpenter::DefinitionCollection.new
definitions.load_requirements requirements
definitions.load_definitions File.join(Dir.pwd, "requirements/**/*.rb")
tree = Carpenter::Tree.new(definitions.requirements, definitions.verifications, definitions.plans)

case command
when 'verify'
  tree.verifier = true
  puts tree.output options[:output]
when 'show'
  puts tree.output options[:output]
when 'build'
  build = Carpenter::Build.new(definitions.requirements, definitions.verifications, definitions.plans)
  build.run
end

